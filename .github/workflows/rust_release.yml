name: Rust Release

on:
  workflow_dispatch:

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  release:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Ensure stable toolchain
        run: rustup default stable

      - name: Output Rust versions
        run: |
          rustup --version
          rustc --version
          cargo --version

      - name: Cache cargo directories
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install cargo-edit for version bumping
        run: cargo install cargo-edit --locked

      - name: Bump version (patch)
        run: cargo set-version --bump patch

      - name: Read current version from Cargo.toml
        id: get_version
        shell: pwsh
        run: |
          $content = Get-Content -Raw -Path "Cargo.toml"
          $packageSection = ($content -split "\r?\n\r?\n") | Where-Object { $_ -match "^\[package\]" }
          if (-not $packageSection) { throw "[package] section not found in Cargo.toml" }
          $m = [regex]::Match($packageSection, 'version\s*=\s*"([^"]+)"')
          if (-not $m.Success) { throw "Version not found in Cargo.toml" }
          $v = $m.Groups[1].Value
          "version=$v" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Commit version bump and tag
        env:
          VERSION: ${{ steps.get_version.outputs.version }}
        shell: pwsh
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Cargo.toml Cargo.lock
          if ((git diff --cached --name-only).Length -gt 0) {
            git commit -m "chore(release): bump version to $env:VERSION"
          } else {
            Write-Host "No changes to commit (version may already be bumped)."
          }
          git tag v$env:VERSION -f
          git push origin HEAD:main --tags --force-with-lease

      - name: Build Windows release binary
        run: cargo build --release

      - name: Verify executable exists
        shell: pwsh
        run: |
          $exe = "target\release\vrc-ytdlp.exe"
          if (-not (Test-Path $exe)) { throw "Executable not found at $exe" }

      - name: Create release ZIP
        id: zip
        env:
          VERSION: ${{ steps.get_version.outputs.version }}
        shell: pwsh
        run: |
          $zipName = "vrc-ytdlp-$env:VERSION.zip"
          if (Test-Path $zipName) { Remove-Item $zipName -Force }
          $paths = @(
            "config.json",
            "install.bat",
            "uninstall.bat",
            "target\release\vrc-ytdlp.exe"
          )
          foreach ($p in $paths) { if (-not (Test-Path $p)) { throw "Required file not found: $p" } }
          Compress-Archive -Path $paths -DestinationPath $zipName -Force
          "zip=$zipName" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Create GitHub Release and upload asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          name: vrc-ytdlp v${{ steps.get_version.outputs.version }}
          files: ${{ steps.zip.outputs.zip }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
